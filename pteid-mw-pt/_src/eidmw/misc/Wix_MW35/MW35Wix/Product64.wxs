<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:difx="http://schemas.microsoft.com/wix/DifxAppExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
	<?include ..\..\..\svn_revision.wxs ?>

	<?define var.OfficialProductVersion =2.4.0?>
	<?define var.ProductVersion =2.4.$(var.RevisionNumber)?>
	<?define var.FullProductVersion =$(var.OfficialProductVersion).$(var.RevisionNumber)?>

	<?define var.UpgradeCode ={41D2DFA4-7754-465C-9379-55CDBADE082D}?>
	<?define var.ProductGuid ={824563DE-75AD-4166-9DC0-B6482F20$(var.RevisionNumber)}?>
	<?define var.ProductGuidGeneric ={824563DE-75AD-4166-9DC0-B6482F2?????}?>
	<!--<?define var.ProductGuid ={824563DE-75AD-4166-9DC0-B6482F2DED5A})?>-->
	<?define var.ProductName =Cartão de Cidadão Português $(var.OfficialProductVersion) (build $(var.RevisionNumber))?>

	<?define var.PackageCode="*"?>

	<Product Id="$(var.ProductGuid)"
			 Name="$(var.ProductName)"
			 Language="!(loc.Lang)"
			 Codepage="1252"
			 Version="$(var.ProductVersion)"
			 Manufacturer="Portuguese Government"
			 UpgradeCode="$(var.UpgradeCode)">

		<Package Id="$(var.PackageCode)"
				 InstallerVersion="300"
				 Keywords="Portugal e-ID Middleware Installer"
				 Platform="x64"
         Comments="Portuguese eID Middleware 2.4.0 SVN Revision $(var.RevisionNumber)"
				 Manufacturer="Portuguese Government"
				 Compressed="yes"
				 InstallPrivileges="elevated"
    />

		<Upgrade Id="$(var.UpgradeCode)">
			<UpgradeVersion Minimum="$(var.ProductVersion)"
							IncludeMinimum="no"
							OnlyDetect="yes"
							Property="NEWPRODUCTFOUND"
      />
			<UpgradeVersion Minimum="1.0.0"
							IncludeMinimum="yes"
							Maximum="$(var.ProductVersion)"
							IncludeMaximum="no"
							Property="UPGRADEFOUND"
      />
		</Upgrade>

		<?ifndef env.PTEID_DIR_MSM?>
	     	<?error PTEID_DIR_MSM not defined ?>
		<?else?>
			<?define var.PTEID_DIR_MSM=$(env.PTEID_DIR_MSM)?>
		<?endif?>
    
    <?define var.PTEID_QT_IMAGEFORMATS=$(env.PTEID_DIR_QT_4_X64)\plugins\imageformats\?>

	    
    
    <!-- Choose the target runtime to use: -->
	    <!-- hack: Checking the solution file that was loaded with the visual studio -->
	    <!-- $(var.SolutionName: 
	       {
	        PteidEasyBuild      (visual studio 2005) 
	        PteidEasyBuild.2008 (visual studio 2008)
	       } 
	    -->
	    <?if $(var.SolutionName) = PteidEasyBuild ?>
	      <?define var.PTEID_TARGET_RUNTIME=VCR8 ?>
	    <?elseif $(var.SolutionName) = PteidEasyBuild.2008 ?>
	      <?define var.PTEID_TARGET_RUNTIME=VCR9 ?>
		<?else?>
	      <?error Can't determine the Visual studio runtime to use. ?>
		<?endif?>

    	<!-- Look for compiled components and libs in: -->
	    <?if $(var.PTEID_TARGET_RUNTIME) = VCR8 ?>
	      <!-- In the future it should all be using this path format!
	      <?define var.PTEID_BUILD_FOLDER_X86=..\..\..\_Binaries35\Win32\VC8\Release\ ?>
	      <?define var.PTEID_BUILD_FOLDER_X64=..\..\..\_Binaries35\x64\VC8\Release\ ?>
	      <?define var.PTEID_BUILD_FOLDER_AnyCPU=..\..\..\_Binaries35\AnyCPU\VC8\Release\ ?>
	      -->
	      <?define var.PTEID_BUILD_FOLDER_X86=..\..\..\_Binaries35\Release\ ?>
	      <?define var.PTEID_BUILD_FOLDER_X64=..\..\..\_Binaries35\x64\Release\ ?>
	      <!-- just using for c# dll for now (java here would also be useful). -->
	      <?define var.PTEID_BUILD_FOLDER_AnyCPU=..\..\..\_Binaries35\Release ?>
	    <?elseif $(var.PTEID_TARGET_RUNTIME) = VCR9 ?>
	      <?define var.PTEID_BUILD_FOLDER_X86=..\..\..\_Binaries35\Win32\VC9\Release\ ?>
	      <?define var.PTEID_BUILD_FOLDER_X64=..\..\..\_Binaries35\x64\VC9\Release\ ?>
	      <?define var.PTEID_BUILD_FOLDER_AnyCPU=..\..\..\_Binaries35\AnyCPU\VC9\Release\ ?>
		<?endif?>

		<WixVariable Id="WixUILicenseRtf" Value="..\..\..\misc\licenses_files\License_en.rtf" />
		<WixVariable Id="WixUIBannerBmp" Value="..\..\..\misc\Wix_MW35\new_banner.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="..\..\..\misc\Wix_MW35\dlgbmp.bmp" />

		<Condition Message="!(loc.MinOs)">
			<![CDATA[
      Installed
      OR ((VersionNT = 500) and (ServicePackLevel > 3))
      OR ((VersionNT = 501) and (ServicePackLevel > 1))
      OR (VersionNT > 501)
      ]]>
		</Condition>

		<Media Id="1" Cabinet="Middleware.cab" EmbedCab="yes" CompressionLevel="high"/>

		<Icon Id="pteid.ico" SourceFile="..\..\..\eidgui\Images\Icons\pteid.ico"/>

		<Property Id="ARPPRODUCTICON" Value="pteid.ico" />
		<Property Id="ARPURLINFOABOUT" Value="http://www.cartaodecidadao.pt"/>

		<Property Id="ALLUSERS" Value="1" />

		<Property Id="OLDMIDDLEWAREINSTALLED">
			<RegistrySearch Id="OldMiddlewareInstalled_search" Name="Version" Type="raw" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{89266692-369C-4B31-BA95-DA601180FB03}"/>
		</Property>

		<Condition Message="!(loc.OldMiddlewareErrorMsg)" >
			<![CDATA[Installed OR NOT OLDMIDDLEWAREINSTALLED]]>
		</Condition>

		<Directory Id="TARGETDIR" Name="SourceDir">

			<Directory Id="ProgramMenuFolder" Name="Menu">
				<Directory Id="ApplicationProgramsFolder" Name="Cartão de Cidadão">
					<Directory Id="ApplicationProgramsFolderUtilities" Name="Utilitários"/>
				</Directory>
			</Directory>

			<Directory Id="ProgramFilesFolder">
				<Directory Id="FIREFOXROOTFOLDER" Name="Mozilla Firefox">
					<Directory Id="FIREFOXEXTENSIONS" Name="extensions">
						<Directory Id="XPIROOTFOLDER" Name="portugaleid@eid.portugal.pt">
							<Directory Id="XPICONTENTFOLDER" Name="content"/>
							<Directory Id="XPICOMPONENTSFOLDER" Name="components"/>
							<Directory Id="XPIDEFAULTSFOLDER" Name="defaults">
								<Directory Id="XPIDEFAULTSPREFSFOLDER" Name="preferences"/>
							</Directory>
							<Directory Id="XPILOCALEFOLDER" Name="locale">
								<Directory Id="XPILOCALEENFOLDER" Name="en-US"/>
								<Directory Id="XPILOCALEFRFOLDER" Name="fr-FR"/>
								<Directory Id="XPILOCALENLFOLDER" Name="nl-NL"/>
								<Directory Id="XPILOCALEDEFOLDER" Name="de-DE"/>
							</Directory>
							<Directory Id="XPISKINFOLDER" Name="skin"/>
						</Directory>
						<Directory Id="CERTINSTALLROOTFOLDER" Name="pteidcertinstall@caixamagica.pt">
							<Directory Id="CERTINSTALLCONTENTFOLDER" Name="chrome"/>
							<Directory Id="CERTINSTALLCOMPONENTSFOLDER" Name="components"/>
							<Directory Id="CERTINSTALLMODULESFOLDER" Name="modules"/>
							<Directory Id="CERTINSTALLDEFAULTSFOLDER" Name="defaults">
								<Directory Id="CERTINSTALLPREFERENCESFOLDER" Name="preferences"/>
							</Directory>
						</Directory>
					</Directory>
				</Directory>
			</Directory>

			<Directory Id="ProgramFiles64Folder">
				<Directory Id="MINIDRIVERROOTFOLDER" Name="PTeID Minidriver"/>
				<Directory Id="APPLICATIONROOTFOLDER" Name="Portugal Identity Card">
					<Directory Id="IMAGEFORMATS" Name="imageformats" />
          
          <Directory Id="DSS" Name="DSS"/>
          <Directory Id="SCAP" Name="SCAP">
            <Directory Id="CERTS_SCAP_DIR" Name="certificates"/>
            <Directory Id="SCAP_SYSWOW" Name="syswow"/>
            <Directory Id="SCAP_AMD64" Name="amd64"/>
          </Directory>
            <Directory Id="EIDSTORE" Name="eidstore">
						<Directory Id="CERTSDIR" Name="certs"/>
						<Directory Id="CRLDIR" Name="crl">
							<Directory Id="HTTPDIR" Name="http">
								<Directory Id="CRLEIDBELGIUMBE" Name="crl.eid.portugal.be"/>
							</Directory>
						</Directory>
					</Directory>
					<Directory Id="DIRECTORYCACHE" Name=".cache"/>
					<Directory Id="LOGDIR" Name="log"/>
					<Directory Id="SDK" Name="sdk">
						<Directory Id="JAVA_SDK" Name="Java"/>
						<Directory Id="CSHARP_SDK" Name="CSharp"/>
					</Directory>
				</Directory>

			</Directory>

			<Directory Id="DesktopFolder"/>

			<Directory Id="WindowsFolder"/>

			<Directory Id="System64Folder">

			</Directory>

			<Directory Id="SystemFolder"></Directory>
      
	      <?if $(var.PTEID_TARGET_RUNTIME) = VCR8 ?>
		        <!-- VC8 runtime -->
		        <?define var.VCRT_TITLE="VC++ 8.0 runtime" ?>
				<Merge Id="VCRT"        SourceFile="$(var.PTEID_DIR_MSM)\Microsoft_VC80_CRT_x86_x64.msm" Language="0" DiskId="1" />
				<Merge Id="VCRT_POLICY" SourceFile="$(var.PTEID_DIR_MSM)\policy_8_0_Microsoft_VC80_CRT_x86_x64.msm" Language="0" DiskId="1" />
	      <?elseif $(var.PTEID_TARGET_RUNTIME) = VCR9 ?>
		        <!-- VC9 runtime -->
		        <?define var.VCRT_TITLE="VC++ 9.0 runtime" ?>
		        <Merge Id="VCRT"        SourceFile="$(var.PTEID_DIR_MSM)\Microsoft_VC90_CRT_x86_x64.msm" Language="0" DiskId="1" />
		        <Merge Id="VCRT_POLICY" SourceFile="$(var.PTEID_DIR_MSM)\policy_9_0_Microsoft_VC90_CRT_x86_x64.msm" Language="0" DiskId="1" />
	      <?endif?>
      
			</Directory>

			<DirectoryRef Id="EIDSTORE">
				<Component Id="EidStore" Guid="{F30FFFBD-4F50-4e4d-86D2-90F192A3F01B}" KeyPath="yes">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<RemoveFile Id="RemoveEidstoreFiles" On="uninstall" Name="*"/>
					<RemoveFolder Id="RemoveEidstoreFolder" On="uninstall"/>
				</Component>
			</DirectoryRef>



    <DirectoryRef Id="DSS">
      <Component Id="DSSApp" Guid="{CDA14D17-04E8-4f4b-BEE1-771A0DDC2558}">
        <File Id="dss_standalone.exe" Name="dss-standalone.exe" KeyPath="yes" Source="..\..\..\misc\DSS\dss-standalone.exe" />
        <File Id="config_dss.properties" Name="config.properties" Source="..\..\..\misc\DSS\config.properties" />
      </Component>
    </DirectoryRef>


    <DirectoryRef Id="SCAP">
      <Component Id="scap" Guid="{BFA2692F-44F0-4d76-8950-5FF9E0D117F4}">
        <File Source="..\..\scap\SCAP-Signature-runnable.jar" KeyPath="yes" />
        <File Source="..\..\scap\config.properties" />
        <File Source="..\..\scap\logging.properties" />
        <File Id="libcurl4A" Source="..\..\scap\libcurl4.dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SCAP_AMD64">
      <Component Id="scapAmd64" Guid="{BFA2692F-44F0-4d76-1250-5FF9E0D117F4}">
        <File Source="..\..\scap\amd64\libcurl4.dll" />        
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="SCAP_SYSWOW">
      <Component Id="scapSyswow" Guid="{BFA2692F-44F0-4d76-8950-5FF9E0D237F4}">
        <File Id="libeay31B" Source="..\..\scap\syswow\libeay32.dll" />
        <File Id="javaWrapper2" Source="..\..\scap\syswow\pteidlibJava_Wrapper.dll" />
        <File Id="ssleay32B" Source="..\..\scap\syswow\ssleay32.dll" />
        <File Id="popplerA" Source="..\..\scap\syswow\pteid-poppler.dll"/>
      </Component>
    </DirectoryRef>
    
    <DirectoryRef Id="CERTS_SCAP_DIR">
      <Component Id="CertsScap" Guid="{750F471B-6A83-4118-A0AF-2A138B770AF6}">
        <File Source="..\..\scap\certificates\Teste Cartao de Cidadao 001.cer" />
        <File Source="..\..\scap\certificates\Teste Cartao de Cidadao 002.cer" />
        <File Source="..\..\scap\certificates\Teste Cartao_de_Cidadao_raiz_002.cer" />
        <File Source="..\..\scap\certificates\Teste Cartao_de_Cidadao_raiz_002_2.cer" />
        <File Source="..\..\scap\certificates\Teste EC de Assinatura Digital Qualificada do Cartao de Cidadao 0001.cer" />
        <File Source="..\..\scap\certificates\Teste EC de Assinatura Digital Qualificada do Cartao de Cidadao 0002.cer" />
        <File Source="..\..\scap\certificates\Teste EC de Assinatura Digital Qualificada do Cartao de Cidadao 0003.cer"/>
        <File Source="..\..\scap\certificates\Teste EC de Assinatura Digital Qualificada do Cartao de Cidadao 0004.cer"/>
        <File Source="..\..\scap\certificates\Teste EC de Assinatura Digital Qualificada do Cartao de Cidadao 0005.cer" />
        <File Source="..\..\scap\certificates\Teste EC de Autenticacao do Cartao de Cidadao 0001.cer"/>
        <File Source="..\..\scap\certificates\Teste EC de Autenticacao do Cartao de Cidadao 0002.cer"/>
        <File Source="..\..\scap\certificates\Teste EC de Autenticacao do Cartao de Cidadao 0003.cer"/>
        <File Source="..\..\scap\certificates\Teste EC de Autenticacao do Cartao de Cidadao 0004.cer"/>
        <File Source="..\..\scap\certificates\Teste EC de Autenticacao do Cartao de Cidadao 0005.cer"/>
        <File Source="..\..\scap\certificates\Teste EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0007.cer"/>
        <File Source="..\..\scap\certificates\Teste EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0008.cer"/>
        <File Source="..\..\scap\certificates\Teste EC_de_Autenticacao_do_Cartao_de_Cidadao_0007.cer"/>
        <File Source="..\..\scap\certificates\Teste EC_de_Autenticacao_do_Cartao_de_Cidadao_0008.cer"/>
      </Component>
    </DirectoryRef>
    
    <DirectoryRef Id="IMAGEFORMATS">
      <Component Id="ImagePlugins" Guid="{750F471B-6A83-4118-A0AF-2A138B770AC6}">
        <File Source="$(var.PTEID_QT_IMAGEFORMATS)\qico4.dll" KeyPath="yes"/>
        <File Source="$(var.PTEID_QT_IMAGEFORMATS)\qjpeg4.dll"/>
      </Component>
      
    </DirectoryRef>
		
		<DirectoryRef Id="CERTSDIR">
			<Component Id="Certs" Guid="{750F471B-6A83-4118-A0AF-2A138B770AD6}">
		        <File Source="..\..\certs\CartaodeCidadao001.der" KeyPath="yes" />
		        <File Source="..\..\certs\CartaodeCidadao002.der" />
            <File Source="..\..\certs\CartaodeCidadao003.der" />
		        <File Source="..\..\certs\ECRaizEstado_novo_assinado_GTE.der" />
		        <File Source="..\..\certs\GTEGlobalRoot.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0001.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0002.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0003.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0004.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0005.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0006.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0007.der" />
		        <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0008.der" />
            <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0009.der" />
            <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0010.der" />
            <File Source="..\..\certs\EC_de_Assinatura_Digital_Qualificada_do_Cartao_de_Cidadao_0011.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0001.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0002.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0003.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0004.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0005.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0006.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0007.der" />
		        <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0008.der" />
            <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0009.der" />
            <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0010.der" />
            <File Source="..\..\certs\EC_de_Autenticacao_do_Cartao_de_Cidadao_0011.der" />
			</Component>
		</DirectoryRef>

			<DirectoryRef Id="CRLDIR">
				<Component Id="CrlDir" Guid="{5731B322-17EE-4d08-90A5-9DB53F53EC29}">
					<CreateFolder/>
					<RemoveFile Id="RemoveCrlCacheFiles" On="uninstall" Name="*"/>
					<RemoveFolder Id="RemoveCrlCacheFolder" On="uninstall"/>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="HTTPDIR">
				<Component Id="HttpDir" Guid="{24B807B8-E1F2-42BB-976D-C98B7F52A119}" KeyPath="yes">
					<CreateFolder />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="CRLEIDBELGIUMBE">
				<Component Id="CrlEidPortugalBe" Guid="{26BEC283-40A5-43A8-BC57-351DA9F79B33}" KeyPath="yes">
					<CreateFolder />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="LOGDIR">
				<Component Id="LogDir" Guid="{A300DA04-F8DF-4506-B654-1E5EB2782DF3}" KeyPath="yes">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<RemoveFile Id="RemoveLogFiles" On="uninstall" Name="*"/>
					<RemoveFolder Id="RemoveLogFolder" On="uninstall"/>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="DIRECTORYCACHE">
				<Component Id="DirectoryCache" Guid="{7CAEB639-7068-4084-B422-D7B5E55D0FBC}" KeyPath="yes">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<RemoveFile Id="RemoveCacheFiles" On="uninstall" Name="*"/>
					<RemoveFolder Id="RemoveCacheFolder" On="uninstall"/>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="FIREFOXEXTENSIONS">
				<Component Id="Extensions" Guid="{DBEFB6AD-3282-4625-8257-2CF7EA4E7264}" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users"/>
					</CreateFolder>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="FIREFOXROOTFOLDER">
				<Component Id="FireFoxRoot" Guid="{3F6140E7-B25A-41c5-BACE-9DBCDE8019D9}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPIROOTFOLDER">
				<Component Id="XPIRoot" Guid="{6E56CA5C-29ED-47e0-9EEF-64FDF8A0B353}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="chrome.manifest" Name="chrome.manifest" KeyPath="no" Source="..\..\..\xpi\src\chrome.manifest" />
					<File Id="icon.png.root" Name="icon.png" KeyPath="no" Source="..\..\..\xpi\src\icon.png" />
					<File Id="install.rdf" Name="install.rdf" KeyPath="no" Source="..\..\..\xpi\src\install.rdf" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPICONTENTFOLDER">
				<Component Id="XPIContent" Guid="{DC052180-264F-4ace-ACF1-FC482715EB86}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="portugaleidpkcs11.js" Name="portugaleidpkcs11.js" KeyPath="no" Source="..\..\..\xpi\src\content\portugaleidpkcs11.js" />
					<File Id="portugaleidpkcs11.xul" Name="portugaleidpkcs11.xul" KeyPath="no" Source="..\..\..\xpi\src\content\portugaleidpkcs11.xul" />
					<File Id="portugaleidprompt.js" Name="portugaleidprompt.js" KeyPath="no" Source="..\..\..\xpi\src\content\portugaleidprompt.js" />
					<File Id="portugaleidprompt.xul" Name="portugaleidprompt.xul" KeyPath="no" Source="..\..\..\xpi\src\content\portugaleidprompt.xul" />
					<File Id="portugaleidpromptsecure.js" Name="portugaleidpromptsecure.js" KeyPath="no" Source="..\..\..\xpi\src\content\portugaleidpromptsecure.js" />
					<File Id="portugaleidpromptsecure.xul" Name="portugaleidpromptsecure.xul" KeyPath="no" Source="..\..\..\xpi\src\content\portugaleidpromptsecure.xul" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPICOMPONENTSFOLDER">
				<Component Id="XPIComponents" Guid="{2761C1B0-4EA2-4047-8A31-32679BB4651D}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="comp_portugaleidpkcs11.js" Name="portugaleidpkcs11.js" KeyPath="no" Source="..\..\..\xpi\src\components\portugaleidpkcs11.js" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPIDEFAULTSFOLDER">
				<Component Id="XPIdefaults" Guid="{B635FD45-0FCE-4285-9FA6-F9559C0F7EBB}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPIDEFAULTSPREFSFOLDER">
				<Component Id="XPIdefaultsprefs" Guid="{FA937E34-AE32-4acd-AC77-3487EBC2ABCD}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="portugaleid.js" Name="portugaleid.js" KeyPath="no" Source="..\..\..\xpi\src\defaults\preferences\portugaleid.js" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPILOCALEFOLDER">
				<Component Id="XPIlocale" Guid="{B8A44A30-F2EF-44c3-BBE5-54395F47C869}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPILOCALEENFOLDER">
				<Component Id="XPIlocaleen" Guid="{F2BBAA41-E463-409d-B4AB-CE3626339663}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="portugaleid.properties.en" Name="portugaleid.properties" KeyPath="no" Source="..\..\..\xpi\src\locale\en-US\portugaleid.properties" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPILOCALEFRFOLDER">
				<Component Id="XPIlocalefr" Guid="{C0F969BB-3678-4828-BAE7-023054072A01}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="portugaleid.properties.fr" Name="portugaleid.properties" KeyPath="no" Source="..\..\..\xpi\src\locale\fr-FR\portugaleid.properties" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPILOCALENLFOLDER">
				<Component Id="XPIlocalenl" Guid="{E8587941-7B32-4a9d-8F4B-23C1E8EC1126}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="portugaleid.properties.nl" Name="portugaleid.properties" KeyPath="no" Source="..\..\..\xpi\src\locale\nl-NL\portugaleid.properties" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPILOCALEDEFOLDER">
				<Component Id="XPIlocalede" Guid="{54BC660D-7C9D-4ddc-AA96-29D7A5DD0E53}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="portugaleid.properties.de" Name="portugaleid.properties" KeyPath="no" Source="..\..\..\xpi\src\locale\de-DE\portugaleid.properties" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="XPISKINFOLDER">
				<Component Id="XPIskin" Guid="{7FF22F5F-E42E-47af-91EE-9A9491B196AC}" KeyPath="no" Win64="no">
					<CreateFolder>
						<util:PermissionEx GenericAll="yes" User="Users" />
					</CreateFolder>
					<File Id="overlay.css" Name="overlay.css" KeyPath="no" Source="..\..\..\xpi\src\skin\overlay.css" />
					<File Id="icon.png" Name="icon.png" KeyPath="no" Source="..\..\..\xpi\src\skin\icon.png" />
					<File Id="icon40x40.png" Name="icon40x40.png" KeyPath="no" Source="..\..\..\xpi\src\skin\icon40x40.png" />
				</Component>
			</DirectoryRef>


			<DirectoryRef Id="CERTINSTALLROOTFOLDER">
				<Component Id="pteidcertinstallroot" Guid="9a02e931-4d7c-4dc5-aaf1-788e2f282941" Win64="no">
					<File Id="cck.config" Name="cck.config" KeyPath="yes" Source="..\..\..\ffpteidcertinstall\xpi\cck.config" />
					<File Id="install_certinstall.rdf" Name="install.rdf" KeyPath="no" Source="..\..\..\ffpteidcertinstall\xpi\install.rdf" />
					<File Id="chrome_certinstall.manifest" Name="chrome.manifest" KeyPath="no" Source="..\..\..\ffpteidcertinstall\xpi\chrome.manifest" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="CERTINSTALLCONTENTFOLDER">
				<Component Id="pteidcertinstallchrome" Guid="9a02e931-4d7c-4dc5-aaf1-788e2f282942" Win64="no">
					<File Id="cck.jar" Name="cck.jar" KeyPath="yes" Source="..\..\..\ffpteidcertinstall\xpi\chrome\cck.jar"></File>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="CERTINSTALLCOMPONENTSFOLDER">
				<Component Id="pteidcertinstallcomponents" Guid="9a02e931-4d7c-4dc5-aaf1-788e2f282945" Win64="no">
					<File Id="cckService.js" Name="cckService.js" KeyPath="yes" Source="..\..\..\ffpteidcertinstall\xpi\components\cckService.js"></File>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="CERTINSTALLMODULESFOLDER">
				<Component Id="pteidcertinstallmodules" Guid="9a02e931-4d7c-4dc5-aaf1-788e2f282943" Win64="no">
					<File Id="cckModule.jsm" Name="cckModule.jsm" KeyPath="yes" Source="..\..\..\ffpteidcertinstall\xpi\modules\cckModule.jsm"></File>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="CERTINSTALLPREFERENCESFOLDER">
				<Component Id="pteidcertinstallpreferences" Guid="9a02e931-4d7c-4dc5-aaf1-788e2f282944" Win64="no">
					<File Id="firefoxcck.js" Name="firefox-cck.js" KeyPath="yes" Source="..\..\..\ffpteidcertinstall\xpi\defaults\preferences\firefox-cck.js"></File>
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="MINIDRIVERROOTFOLDER">
				<Component Id="pteidmdrv" Guid="2bdf2bb0-4f7a-4ed6-a3d4-abcbe212fa14" Win64="yes">
					<File Id="pteidmdrv.inf" Name="pteidmdrv.inf" Source="..\..\..\minidriver\makemsi\Release\pteidmdrv.inf" KeyPath="yes" DiskId="1" />
					<File Id="pteidmdrv.cat" Name="pteidmdrv.cat" Source="..\..\..\minidriver\makemsi\Release\pteidmdrv.cat" KeyPath="no" DiskId="1" />
					<File Id="pteidmdrv32.dll" Name="pteidmdrv32.dll" Source="..\..\..\minidriver\makemsi\Release\pteidmdrv32.dll" KeyPath="no" DiskId="1" />
					<File Id="pteidmdrv64.dll" Name="pteidmdrv64.dll" Source="..\..\..\minidriver\makemsi\Release\pteidmdrv64.dll" KeyPath="no" DiskId="1" />
					<difx:Driver ForceInstall="no" PlugAndPlayPrompt="no" DeleteFiles="yes" />
				</Component>
				<!-- Certificate Propagation Service is a standard Windows service available in from Windows Vista on. In order to use the minidriver
			   it is necessary that this service is running. When a smart card reader is inserted this service should be started  by the smart card
			   driver. As not all drivers are following this guidance, we start CertPropSvc during the minidriver install -->
				<Component Id="CertPropService" Guid="932459d0-df59-11de-8a39-0800200c9a66" Permanent="yes" Win64="yes">
					<!-- Start Certificate Propagation Service during startup -->
					<RegistryValue Root="HKLM" Key="System\CurrentControlSet\Services\CertPropSvc" Type="integer" Name="Start" Value="2" KeyPath="yes"/>
					<!-- Start Certificate Propagation Service now -->
					<!--<ServiceControl Id="StartCertPropSvc" Name="CertPropSvc" Start="install" />-->
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="APPLICATIONROOTFOLDER">

				<Component Id="RootFolder" Guid="{2FB5D279-50BD-49ed-98D9-3D043520F450}">
					<CreateFolder/>
					<Environment Id="PATH" Action="set" Part="last" Permanent="no" System="yes" Name="PATH" Value="[ProgramFiles64Folder]Portugal Identity Card"/>
					<Environment Id="CLASSPATH" Action="set" Part="last" Permanent="no" System="yes" Name="CLASSPATH" Value="[ProgramFiles64Folder]Portugal Identity Card"/>
				</Component>

				<Component Id="Icon" Guid="{5B657BAD-8CFC-4E42-AF8C-13338C50D784}" SharedDllRefCount="yes">
          			<File Source="..\..\..\misc\assinatura.ico" KeyPath="yes" />
				</Component>

				<Component Id="OutlookTool" Guid="{F36A543C-CB17-4D91-BF0C-2EAEFEC3CB3A}">
          			<File Source="..\..\..\misc\setup_win\pteidoutlooksnc.exe" KeyPath="yes" />
				</Component>

				<Component Id="GUI" Guid="{E45C85CA-0A5A-400C-9B86-7038C82B254D}" SharedDllRefCount="yes">
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)pteidgui.exe" KeyPath="yes" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)pteidlibCpp.dll" />
				</Component>


        <Component Id="Runtime35ThirdPartyOpenSSL" Guid="{A98B4895-7CCF-4A91-ACE2-433B8D4363F8}" SharedDllRefCount="yes">
          <File Source="$(var.PTEID_BUILD_FOLDER_X64)libeay32.dll" KeyPath="yes"/>
          <File Source="$(var.PTEID_BUILD_FOLDER_X64)ssleay32.dll" />
        </Component>

				<Component Id="GuiLang" Guid="{6B03ED1B-DF24-4CE6-A70C-476AF4C0941B}" SharedDllRefCount="yes">
			          <File Source="..\..\..\eidgui\eidmw_en.qm" KeyPath="yes" />
			          <File Source="..\..\..\eidgui\eidmw_nl.qm" />
				</Component>


				<!--Cairo and its dependencies: needed for the PDF export function 
				<Component Id="Cairo" Guid="{DF770DAC-0151-49ea-890A-6E47C664F74E}" SharedDllRefCount="yes">
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)libcairo-2.dll" KeyPath="yes" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)libfreetype-6.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)libpng14-14.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)libfontconfig-1.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)libexpat-1.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)zlib1.dll" />
				</Component>
        -->

				<Component Id="Qt" Guid="{AF5AF018-EE70-4EA9-98BA-9C2947F19060}" SharedDllRefCount="yes">
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)QtCore4.dll" KeyPath="yes" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)QtGui4.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X64)QtNetwork4.dll" />
				</Component>

				<Component Id="License" Guid="{C00AF621-E882-4805-BA9C-B90AA5DBBCB6}" SharedDllRefCount="yes">
			          <File Source="..\..\..\misc\licenses_files\License_en.rtf" KeyPath="yes" />
			          <File Source="..\..\..\misc\licenses_files\THIRDPARTY-LICENSES.txt" />
				</Component>

			</DirectoryRef>


			<DirectoryRef Id="WindowsFolder">

				<Component Id="pteidgui.conf" Guid="{D46BF825-5D1D-4FE9-AC90-5FDB45240DE0}">
					<File Id="pteidgui.conf" Name="pteidgui.conf" KeyPath="yes" Source="..\..\..\..\ThirdParty\pteid_sdk\2.6\bin\pteidgui.conf" />
					<IniFile Id="pteidguiconf1" Directory="WindowsFolder" Name="pteidgui.conf"
					  Section="PTEID_default" Action="addLine" Key="certs"  Value="[ProgramFiles64Folder]Portugal Identity Card\eidstore\certs\"
          />
					<IniFile Id="pteidguiconf2" Directory="WindowsFolder" Name="pteidgui.conf"
					  Section="PTEID_default" Action="addLine" Key="crl"  Value="[ProgramFiles64Folder]Portugal Identity Card\eidstore\crl\http\crl.eid.portugal.be\"
          />
				</Component>

			</DirectoryRef>

			<!-- We need to ship all the 32-bit DLLs to have working 32-bit versions of the PKCS#11 module -->
			<DirectoryRef Id="SystemFolder">

				<Component Win64="no" Id="Runtime35" Guid="{41F033E4-0669-4FD6-8B8E-DE31FE3AAE24}" SharedDllRefCount="yes">
			          <File Source="$(var.PTEID_BUILD_FOLDER_X86)pteidapplayer.dll" KeyPath="yes" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X86)pteid-scap-cardlayer.dll" />
                <File Source="$(var.PTEID_BUILD_FOLDER_X86)pteidcardlayer.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X86)pteidcommon.dll" />
			          <File Source="$(var.PTEID_BUILD_FOLDER_X86)pteidDlgsWin32.dll" />
				</Component>

				<!-- Our heavily stripped-down version of poppler with PDF Signature Support -->
				<!--  <Component Win64="no" Id="Poppler" Guid="{54E15AA8-F4A5-42e8-9D38-3B151223B003}">

        <File Id="pteid_poppler.dll" Name="pteid-poppler.dll" KeyPath="no" Source="..\..\..\_Binaries35\Release\pteid-poppler.dll" ></File>
      </Component>
	  -->

				<Component Win64="no" Id="Runtime35ThirdPartyXerces" Guid="{B1EBF9C5-1A6F-44d4-AA80-DE55AAF052FE}" SharedDllRefCount="yes">
          			<File Source="$(var.PTEID_BUILD_FOLDER_X86)xerces-c_3_1.dll" KeyPath="yes"/>
				</Component>

				<!--Our Build of LibCurl - custom build options to remove unneeded features-->
				<Component Win64="no" Id="Curl" Guid="{1BA8207B-BEC4-43e3-93FA-AE9D25117CFA}" SharedDllRefCount="yes">
          			<File Source="$(var.PTEID_BUILD_FOLDER_X86)libcurl.dll" KeyPath="no" />
				</Component>

				
				<Component Win64="no" Id="FreeImage" Guid="EF7A30DC-47CC-4385-832A-8E871EF69F64" SharedDllRefCount="yes">
         			 <File Source="$(var.PTEID_BUILD_FOLDER_X86)FreeImage.dll" KeyPath="yes" />
				</Component>

				<Component Win64="no" Id="XMLSecurity" Guid="EF7A30DC-47CC-4385-832A-8E871EF69F65" SharedDllRefCount="yes">
          			<File Source="$(var.PTEID_BUILD_FOLDER_X86)xsec_1_6.dll" KeyPath="yes" />
				</Component>

				<Component Win64="no" Id="pkcs11" Guid="D54164C0-795D-4B2D-96C6-C8E395100896" SharedDllRefCount="yes">
          			<File Source="$(var.PTEID_BUILD_FOLDER_X86)pteidpkcs11.dll" KeyPath="yes" />
                <File Source="$(var.PTEID_BUILD_FOLDER_X86)pteid-scap-pkcs11.dll" />
				</Component>

			</DirectoryRef>

			<DirectoryRef Id="System64Folder">

				<Component Id="Runtime35_64" Guid="{8FE1C7FB-F06A-40db-8454-88D9E8BDD626}" SharedDllRefCount="yes" Win64="yes">
			          <File Id="pteidapplayer_64.dll"  Source="$(var.PTEID_BUILD_FOLDER_X64)pteidapplayer.dll" KeyPath="yes" />
			          <File Id="pteidcardlayer_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)pteidcardlayer.dll" />
                <File Id="pteid_scap_cardlayer_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)pteid-scap-cardlayer.dll" />
			          <File Id="pteidcommon_64.dll"    Source="$(var.PTEID_BUILD_FOLDER_X64)pteidcommon.dll" />
			          <File Id="pteidDlgsWin32_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)pteidDlgsWin32.dll" />
				</Component>

				<Component Id="pkcs11_64" Guid="{3C4751D6-D92C-40ab-8FA5-3A1DF1D927EA}" SharedDllRefCount="yes" Win64="yes">
			          <File Id="pteidpkcs11_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)pteidpkcs11.dll" KeyPath="yes" />
          <File Id="pteid_scap_pkcs11_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)pteid-scap-pkcs11.dll"/>
				</Component>

				<Component Id="FreeImage_64" Guid="C3CAF347-FBA3-4d65-A23F-C6357541DAB2" SharedDllRefCount="yes">
          			<File Id="FreeImage_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)FreeImage.dll" KeyPath="yes" />
				</Component>

				<Component Id="XMLSecurity_64" Guid="EF7A30DC-47CC-4385-832A-8E871EF69F66" SharedDllRefCount="yes">
          			<File Id="xsec_1_6_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)xsec_1_6.dll" KeyPath="yes" />
				</Component>

				<!-- Our heavily stripped-down version of poppler with PDF Signature Support -->
				<Component Id="Poppler_64" Guid="{54E15AA8-F4A5-42e8-9D38-3B151223B003}">
          			<File Source="$(var.PTEID_BUILD_FOLDER_X64)pteid-poppler.dll" KeyPath="no" />
				</Component>

				<Component Id="Runtime35ThirdPartyXerces_64" Guid="{B1EBF9C5-1A6F-44d4-AA80-DE55AAF052FF}" SharedDllRefCount="yes">
         			 <File Id="xercesc_3_1_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)xerces-c_3_1.dll" KeyPath="yes"/>
				</Component>

				<!--Our Build of LibCurl - custom build options to remove unneeded features-->
				<Component Id="Curl_64" Guid="{1BA8207B-BEC4-43e3-93FA-AE9D25117CFB}" SharedDllRefCount="yes">
          			<File Id="libcurl_64.dll" Source="$(var.PTEID_BUILD_FOLDER_X64)libcurl.dll" KeyPath="no" />
				</Component>

			</DirectoryRef>

			<DirectoryRef Id="JAVA_SDK">
				<Component Id="Java_SDK_Component" Guid="{8B0D8006-DB84-4986-A8D7-AC5F84F4AEF8}" >
		          <File Source="$(var.PTEID_BUILD_FOLDER_X64)pteidlibJava_Wrapper.dll" KeyPath="yes"/>
		          <File Source="..\..\..\jar\pteidlibJava.jar" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="CSHARP_SDK">
				<Component Id="CSharp_SDK_Component" Guid="{67F8BF67-A48C-4711-9AB7-CAC056FA6C35}">
		          <File Source="$(var.PTEID_BUILD_FOLDER_X64)pteidlibCS_Wrapper.dll" KeyPath="yes"/>
		          <File Source="$(var.PTEID_BUILD_FOLDER_AnyCPU)pteidlibCS.dll" />
				</Component>
			</DirectoryRef>


			<DirectoryRef Id="TARGETDIR">
				<Component Id="SCardSvrService" Guid="{C3BC9746-0843-41b2-BDDA-3192772974CE}" Permanent="yes">
					<!-- Start SCardSvr Service during startup -->
					<RegistryValue Root="HKLM" Key="System\CurrentControlSet\Services\SCardSvr" Type="integer" Name="Start" Value="2" KeyPath="yes"/>
					<!-- Start SCardSvr Service now -->
					<!-- <ServiceControl Id="StartSCardSvrService" Name="SCardSvr" Start="install" /> -->
				</Component>

				<Component Id="REGISTERXPI" Win64="no" Guid="{946B85B6-99CC-4893-8A42-E7EC6FFE0D87}">
					<RegistryKey Root="HKLM"
								 Key="SOFTWARE\Mozilla\Firefox\Extensions"
								 Action="createAndRemoveOnUninstall">
						<RegistryValue Type="string" Name="portugaleid@eid.portugal.pt" Value="C:\Program Files (x86)\Mozilla Firefox\extensions\portugaleid@eid.portugal.pt" KeyPath="yes"/>
						<RegistryValue Type="string" Name="pteidcertinstall@caixamagica.pt" Value="C:\Program Files (x86)\Mozilla Firefox\extensions\pteidcertinstall@caixamagica.pt" KeyPath="no"/>
					</RegistryKey>
				</Component>

				<Component Id="REGISTERMINIDRIVER_64" Guid="{3BCA1B2C-08AF-4727-AD85-1C60025656EA}" Win64="yes">
					<RegistryKey Root="HKLM"
							  Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\Pteid (IAS)"
							  Action="createAndRemoveOnUninstall">
						<RegistryValue Type="string" Name="80000001" Value="pteidmdrv64.dll" KeyPath="yes"/>
						<RegistryValue Type="binary" Name="ATR" Value="3B959540FFD000540130" KeyPath="no"/>
						<RegistryValue Type="binary" Name="ATRMask" Value="fffffffffffffffffffc" KeyPath="no"/>
						<RegistryValue Type="string" Name="Crypto Provider" Value="Microsoft Base Smart Card Crypto Provider" KeyPath="no"/>
						<RegistryValue Type="string" Name="Smart Card Key Storage Provider" Value="Microsoft Smart Card Key Storage Provider" KeyPath="no"/>
					</RegistryKey>
					
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS)" />
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe)" />
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS)" />
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS) 1" />
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe) 1" />
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe) 1"/>
					<RemoveRegistryKey Root="HKLM" Action="removeOnInstall"
						Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS) 1"/>
					
					<RegistryKey Root="HKLM"
					   Key="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\Pteid (Gemsafe)"
					   Action="createAndRemoveOnUninstall">
						<RegistryValue Type="string" Name="80000001" Value="pteidmdrv64.dll" KeyPath="no"/>
						<RegistryValue Type="binary" Name="ATR" Value="3B7D95000080318065B08311000083009000" KeyPath="no"/>
						<RegistryValue Type="binary" Name="ATRMask" Value="ffffffffffffffffffffffff0000ffffffff" KeyPath="no"/>
						<RegistryValue Type="string" Name="Crypto Provider" Value="Microsoft Base Smart Card Crypto Provider" KeyPath="no"/>
						<RegistryValue Type="string" Name="Smart Card Key Storage Provider" Value="Microsoft Smart Card Key Storage Provider" KeyPath="no"/>
					</RegistryKey>

					<!--
						SmartCardName="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe)"
SmartCardName_101="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS)"
SmartCardNameWOW64="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe)"
SmartCardNameWOW64_101="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS)"

SmartCardName_1="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe) 1"
SmartCardName_101_1="SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS) 1"
SmartCardNameWOW64_1="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (GemSafe) 1"
SmartCardNameWOW64_101_1="SOFTWARE\Wow6432Node\Microsoft\Cryptography\Calais\SmartCards\_Portugal eID (IAS) 1"
						
						-->
						
				</Component>

				<Component Id="RegistryXadesFileType" Guid="{414DF15C-6CE6-4181-95B4-D83F16903BA5}">
					<RegistryKey Root="HKLM"
							Key="SOFTWARE\Classes\.ccsigned"
								 Action="createAndRemoveOnUninstall">
						<RegistryValue Type="string" Value="PteidASICSignature"/>
					</RegistryKey>
					<RegistryKey Root="HKLM"
							Key="SOFTWARE\Classes\PteidASICSignature" Action="createAndRemoveOnUninstall">
						<RegistryKey
							Key="shell\Open\command"
								 Action="createAndRemoveOnUninstall">
							<RegistryValue Type="string" Value="C:\Program Files\Portugal Identity Card\DSS\dss-standalone.exe pt &quot;%1&quot;"/>
						</RegistryKey>
						<RegistryKey Key="DefaultIcon"  Action="createAndRemoveOnUninstall">
							<RegistryValue Type="string" Value="[ProgramFiles64Folder]Portugal Identity Card\assinatura.ico"/>
						</RegistryKey>
					<RegistryValue Type="string" Value="Cartão de Cidadão Digital Signature"/>
				</RegistryKey>
					
			</Component>

				<Component Id="RegistryPteidSystem" Guid="{414DF15C-6CE6-4181-95B4-D83F16903BA3}">
					<RegistryKey Root="HKLM"
						Key="SOFTWARE\PTEID"
						Action="createAndRemoveOnUninstall">
						<RegistryKey Key="certificatevalidation" Action="createAndRemoveOnUninstall">
							<RegistryValue Type="integer" Name="cert_validation_ocsp" Value="0"/>
							<RegistryValue Type="integer" Name="cert_validation_crl" Value="0"/>
						</RegistryKey>

						<RegistryKey Key="certificatecache" Action="createAndRemoveOnUninstall">
							<RegistryValue Type="string" Name="cert_cachefile" Value="[ProgramFiles64Folder]Portugal Identity Card\eidstore\crl\.cache.csc"/>
						</RegistryKey>

						<RegistryKey Key="crl" Action="createAndRemoveOnUninstall">
							<RegistryValue Type="string" Name="crl_cachedir" Value="[ProgramFiles64Folder]Portugal Identity Card\eidstore\crl"/>
						</RegistryKey>

						<RegistryKey Key="general" Action="createAndRemoveOnUninstall">
							<RegistryValue Type="string" Name="language" Value="nl"/>
							<RegistryValue Type="string" Name="install_dirname" Value="[ProgramFiles64Folder]Portugal Identity Card"/>
							<RegistryValue Type="integer" Name="show_java_apps" Value="0"/>
						</RegistryKey>

						<RegistryKey Key="logging" Action="createAndRemoveOnUninstall">
							<RegistryValue Type="string" Name="log_dirname" Value="[ProgramFiles64Folder]Portugal Identity Card\log"/>
						</RegistryKey>

						<RegistryKey Key="configuretool" Action="createAndRemoveOnUninstall">
							<RegistryValue Type="integer" Name="start_with_windows" Value="1"/>
							<RegistryValue Type="integer" Name="start_minimized" Value="1"/>
							<RegistryValue Type="integer" Name="show_toolbar" Value="1"/>
							<RegistryValue Type="integer" Name="show_picture" Value="0"/>
							<RegistryValue Type="integer" Name="show_notification" Value="1"/>
							<RegistryValue Type="integer" Name="automatic_cardreading" Value="1"/>
							<RegistryValue Type="integer" Name="cardreader" Value="-1"/>
							<RegistryValue Type="integer" Name="registrate_certificate" Value="1"/>
						</RegistryKey>
					</RegistryKey>

					<RegistryKey Root="HKLM"
								Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run">
						<RegistryValue  Type="string" Name="pteid" Value="&quot;[APPLICATIONROOTFOLDER]pteidgui.exe&quot; /startup"/>
					</RegistryKey>
				</Component>

			</DirectoryRef>


			<DirectoryRef Id="ApplicationProgramsFolder">
				<Component Id="PteidGuiShortcut" Guid="{CBD0F388-EAE5-4FA1-8C38-EC223928FF13}">
					<Shortcut Id="PteidGuiStartMenuShortcut"
							  Name="Cartão de Cidadão"
							  Description="!(loc.PteidGuiDescr)"
							  Target="[APPLICATIONROOTFOLDER]pteidgui.exe"
							  WorkingDirectory="APPLICATIONROOTFOLDER"/>
					<Shortcut Id="EidViewerShortcut"
							  Name="Cartão de Cidadão"
							  Directory="DesktopFolder"
							  Description="!(loc.PteidGuiDescr)"
							  Target="[APPLICATIONROOTFOLDER]pteidgui.exe"
							  WorkingDirectory="APPLICATIONROOTFOLDER"/>
					<RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
					<RegistryValue Root="HKCU" Key="SOFTWARE\PTEID\Installer" Name="GuiShortcut" Type="integer" Value="1" KeyPath="yes" />
				</Component>
			</DirectoryRef>

			<DirectoryRef Id="ApplicationProgramsFolderUtilities">
				<Component Id="OutlookShortcut" Guid="{813C0984-0401-4604-9D7F-E13BDD28FBD7}">
					<Shortcut Id="OutlookStartMenuShortcut"
					  Name="Parametrização do Microsoft Outlook"
					  Description="!(loc.OutlookDescr)"
					  Target="[APPLICATIONROOTFOLDER]pteidoutlooksnc.exe"
					  WorkingDirectory="APPLICATIONROOTFOLDER"/>
					<RemoveFolder Id="ApplicationProgramsFolderUtilities" On="uninstall"/>
					<RegistryValue Root="HKCU" Key="SOFTWARE\PTEID\Installer" Name="OutlookShortcut" Type="integer" Value="1" KeyPath="yes" />
				</Component>
			</DirectoryRef>

			<Feature Id="PteidRuntime"
					 Title="!(loc.PteidRuntime)"
					 Description="!(loc.PteidRuntimeDesc)"
					 Absent="disallow"
					 Level="1"
             >

				<Feature Id="VCRedist" Title="$(var.VCRT_TITLE)" AllowAdvertise="no" Display="hidden" Level="1">
					<MergeRef Id="VCRT" />
					<MergeRef Id="VCRT_POLICY" />
				</Feature>

				<!-- Program Files -->
				<ComponentRef Id="RootFolder"/>
				<ComponentRef Id="Icon" />
				<ComponentRef Id="EidStore"/>
				<ComponentRef Id="Certs"/>
				<ComponentRef Id="CrlDir"/>
				<ComponentRef Id="HttpDir"/>
        <ComponentRef Id="ImagePlugins"/>
				<ComponentRef Id="CrlEidPortugalBe"/>
				<ComponentRef Id="DirectoryCache"/>
				<ComponentRef Id="License"/>
				<ComponentRef Id="LogDir"/>
				<ComponentRef Id="DSSApp"/>
        <ComponentRef Id="scap"/>
        <ComponentRef Id="CertsScap"/>
        <ComponentRef Id="scapAmd64"/>
        <ComponentRef Id="scapSyswow"/>
				<ComponentRef Id="Extensions"/>
				<ComponentRef Id="FireFoxRoot"/>
				<ComponentRef Id="XPIRoot"/>
				<ComponentRef Id="XPIContent"/>
				<ComponentRef Id="XPIComponents"/>
				<ComponentRef Id="XPIdefaults"/>
				<ComponentRef Id="XPIdefaultsprefs"/>
				<ComponentRef Id="XPIlocale"/>
				<ComponentRef Id="XPIlocaleen"/>
				<ComponentRef Id="XPIlocalefr"/>
				<ComponentRef Id="XPIlocalenl"/>
				<ComponentRef Id="XPIlocalede"/>
				<ComponentRef Id="XPIskin"/>
				<ComponentRef Id="pteidcertinstallroot"/>
				<ComponentRef Id="pteidcertinstallchrome"/>
				<ComponentRef Id="pteidcertinstallcomponents"/>
				<ComponentRef Id="pteidcertinstallmodules"/>
				<ComponentRef Id="pteidcertinstallpreferences"/>

				<!-- System32 -->

				<ComponentRef Id="Runtime35"/>
				<ComponentRef Id="Runtime35_64"/>
				<ComponentRef Id="Runtime35ThirdPartyOpenSSL"/>
		<!-- 		<ComponentRef Id="Runtime35ThirdPartyOpenSSL_64"/> -->
				<ComponentRef Id="Runtime35ThirdPartyXerces"/>
				<ComponentRef Id="Runtime35ThirdPartyXerces_64"/>

				<!-- Windows -->
				<ComponentRef Id="pteidgui.conf"/>

				<!-- Registry -->
				<ComponentRef Id="RegistryPteidSystem"/>
				<ComponentRef Id="RegistryXadesFileType"/>

				<Feature Id="GUI"
						  Title="!(loc.PteidGui)"
						  Description="!(loc.PteidGuiDescr)"
						  Level="1"
                >
					<ComponentRef Id="GUI" />
					<ComponentRef Id="Qt" />

					<ComponentRef Id="FreeImage"/>
					<ComponentRef Id="FreeImage_64"/>
					<ComponentRef Id="Curl"/>
					<ComponentRef Id="Curl_64"/>
					<!--    <ComponentRef Id="Poppler"/> -->
					<ComponentRef Id="Poppler_64"/>

					<ComponentRef Id="XMLSecurity"/>
					<ComponentRef Id="XMLSecurity_64"/>
          <!-- <ComponentRef Id="Cairo"/> -->
					<ComponentRef Id="Java_SDK_Component"/>
					<ComponentRef Id="CSharp_SDK_Component"/>
					<ComponentRef Id="GuiLang" />
					<!-- Shortcuts -->
					<ComponentRef Id="PteidGuiShortcut"/>
				</Feature>

				<Feature Id="Crypto"
						  Title="!(loc.Crypto)"
						  Description="!(loc.CryptoDescr)"
						  Level="1"
                >
					<ComponentRef Id="SCardSvrService"/>
					<ComponentRef Id="pkcs11"/>
					<ComponentRef Id="pkcs11_64"/>
					<ComponentRef Id="REGISTERXPI"/>
					<ComponentRef Id="OutlookTool" />
					<!-- Shortcuts -->
					<ComponentRef Id ="OutlookShortcut"/>
					<Feature Id="Install_Minidriver" Level="0" Title="!(loc.Minidriver)" Description="!(loc.MinidriverDescr)">
						<ComponentRef Id="pteidmdrv"/>
						<ComponentRef Id="CertPropService"/>
						<ComponentRef Id="REGISTERMINIDRIVER_64"/>
						<Condition Level="1">VersionNT >= 600</Condition>
					</Feature>
					
				</Feature>
			</Feature>

	    <?if $(var.PTEID_TARGET_RUNTIME) = VCR8 ?>
		  <Binary Id="MarkHidden"    SourceFile="..\..\..\misc\Wix_MW35\MarkHidden\Release\MarkHidden.exe"/>
	      <Binary Id="CleanMdrvKeys" SourceFile="$(var.PTEID_BUILD_FOLDER_X64)clean_mdrv_keys.exe" />
	    <?elseif $(var.PTEID_TARGET_RUNTIME) = VCR9 ?>
	      <Binary Id="MarkHidden"    SourceFile="..\..\..\misc\Wix_MW35\MarkHidden\Build\x64\VC9\Release\MarkHidden.exe" />
	      <Binary Id="CleanMdrvKeys" SourceFile="$(var.PTEID_BUILD_FOLDER_X64)clean_mdrv_keys.exe" />
	    <?endif?>

		<CustomAction Id="CleanMinidriverKeys"
			BinaryKey="CleanMdrvKeys"
			ExeCommand="clean_mdrv_keys.exe"
			Impersonate="no"
			Return="ignore"
			Execute="deferred"/>

			<CustomAction Id="LaunchApplication"
						  FileKey="pteidgui.exe"
						  ExeCommand=""
						  Execute="immediate"
						  Impersonate="yes"
						  Return="asyncNoWait" />

			<!--    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="!(loc.StartApp)" />-->

			<UI>
				<UIRef Id="WixUI_FeatureTree" />
				<Property Id="WIXUI_INSTALLDIR" Value="APPLICATIONROOTFOLDER" />
				<UIRef Id="WixUI_ErrorProgressText" />

				<!--
      <Publish Dialog="ExitDialog" Control="Finish"  Event="DoAction"
               Value="LaunchApplication" Order="1">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
-->
			</UI>

			<CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[APPLICATIONROOTFOLDER]" />

			<CustomAction Id="SetCacheDirHidden"
							Impersonate="no"
							BinaryKey="MarkHidden"
							ExeCommand="&quot;[ProgramFilesFolder]Portugal Identity Card\.cache&quot;"
							Execute="deferred"
							Return="asyncNoWait"
					/>

			<!-- 
    <CustomAction Id="StopGui"
                  BinaryKey="KILLPROCESS"
                  ExeCommand="pteidgui.exe"
                  Impersonate="no"
                  Return="ignore"
                  Execute="deferred"
                 />

    <CustomAction Id="StopGui35"
              BinaryKey="KILLPROCESS"
              ExeCommand="pteidgui.exe"
              Impersonate="no"
              Return="ignore"
              Execute="deferred"
                  />
    
    <CustomAction Id="StopGui35_Remove"
              BinaryKey="KILLPROCESS"
              ExeCommand="pteidgui.exe"
              Impersonate="no"
              Return="ignore"
              Execute="deferred"
                  />

    <CustomAction Id="StopSysTray"
              BinaryKey="KILLPROCESS"
              ExeCommand="pteidsystemtray.exe"
              Impersonate="no"
              Return="ignore"
              Execute="deferred"
                 />
    
    <CustomAction Id="StopXSign"
                  BinaryKey="KILLPROCESS"
                  ExeCommand="xsign.exe"
                  Impersonate="no"
                  Return="ignore"
                  Execute="deferred"
                 />
    
    <CustomAction Id="StopXSign35"
                  BinaryKey="KILLPROCESS"
                  ExeCommand="pteidxsign.exe"
                  Impersonate="no"
                  Return="ignore"
                  Execute="deferred"
                  />

    <CustomAction Id="StopXSign35_Remove"
              BinaryKey="KILLPROCESS"
              ExeCommand="pteidxsign.exe"
              Impersonate="no"
              Return="ignore"
              Execute="deferred"
                  />

    <Binary Id="KILLPROCESS" SourceFile="..\..\..\misc\Wix_MW35\Kill_Process\Release\Kill_Process.exe"/>
-->
			<!--     <Binary Id="MarkHidden" SourceFile="..\..\..\misc\Wix_MW35\MarkHidden\Release\MarkHidden.exe"/>   
           <Binary Id="PTEID_CLEANUP" SourceFile="..\..\..\misc\Wix_MW35\pteidcleanup\Release\pteidcleanup.exe"/>
	-->


			<!--
    Cleanup parameters supported:
    - Avoid to run the cleanup process              =>  CLEANUP_NO=1
    - Force de cleanup to kill all locking process  =>  CLEANUP_FORCE=1
    - Define a specific log file                    =>  CLEANUP_LOG=<FileName>
-->
			<CustomAction Id="ForceCleanup" Property="ForceCleanup" Value="-f " />
			<CustomAction Id="NotForceCleanup" Property="ForceCleanup" Value="" />

			<CustomAction Id="LogCleanup" Property="LogCleanup" Value="-l &quot;[CLEANUP_LOG]&quot; " />
			<CustomAction Id="NotLogCleanup" Property="LogCleanup" Value="" />

			<CustomAction Id="IsQuietMode" Property="QuietMode" Value="-q " />
			<CustomAction Id="NotIsQuietMode" Property="QuietMode" Value="" />

			<CustomAction Id="IsPrivileged" Error="!(loc.AdminNeeded)" />
			<CustomAction Id="PreventDowngrading" Error="!(loc.NoDowngrade)" />
			<Property Id="RUNDLLPATH" Value="C:\Windows\System32\rundll32.exe"> </Property>

			<CustomAction
			Id="MinidriverManualInstall"
			Property="RUNDLLPATH"
			ExeCommand="setupapi.dll,InstallHinfSection DefaultInstall.ntamd64 0 C:\Program Files\PTeID Minidriver\pteidmdrv.inf"
					Impersonate="no"
					Return="check"
					Execute="deferred"
					
					/>

			<InstallUISequence>
				<Custom Action="PreventDowngrading" After="FindRelatedProducts">NEWPRODUCTFOUND</Custom>
			</InstallUISequence>


			<InstallExecuteSequence>
				<Custom Action="PreventDowngrading" After="FindRelatedProducts">NEWPRODUCTFOUND</Custom>
				<RemoveExistingProducts Before="InstallInitialize"/>

				<Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>

				<Custom Action="IsPrivileged" Before="LaunchConditions">Not Privileged</Custom>
				<!---
      <Custom Action="StopGui"         Before="InstallFiles">1</Custom>
      <Custom Action="StopGui35"       Before="InstallFiles">1</Custom>
      <Custom Action="StopSysTray"     Before="InstallFiles">1</Custom>
      <Custom Action="StopXSign"       Before="InstallFiles">1</Custom>
      <Custom Action="StopXSign35"     Before="InstallFiles">1</Custom>

      <Custom Action="StopGui35_Remove"       Before="RemoveFiles">1</Custom>
      <Custom Action="StopXSign35_Remove"     Before="RemoveFiles">1</Custom>
-->
				<!---
      <Custom Action="IsQuietMode" Before="PteidCleanup"><![CDATA[UILevel<5 OR NOT UILevel]]></Custom>
      <Custom Action="NotIsQuietMode" Before="PteidCleanup"><![CDATA[UILevel>=5]]></Custom>

      <Custom Action="LogCleanup" Before="PteidCleanup">CLEANUP_LOG</Custom>
      <Custom Action="NotLogCleanup" Before="PteidCleanup">NOT CLEANUP_LOG</Custom>
     
      <Custom Action="ForceCleanup" Before="PteidCleanup">CLEANUP_FORCE=1</Custom>
      <Custom Action="NotForceCleanup" Before="PteidCleanup"><![CDATA[CLEANUP_FORCE<>1 OR NOT CLEANUP_FORCE]]></Custom>
     -->
	<Custom Action="SetCacheDirHidden"  After="InstallFiles">NOT Installed</Custom>
	<Custom Action="CleanMinidriverKeys" After="RemoveRegistryValues">NOT Installed</Custom>
	<Custom Action="MinidriverManualInstall" After="InstallFiles"> NOT Installed and VersionNT = 600</Custom>

		<ScheduleReboot After="InstallFinalize">NOT Installed</ScheduleReboot>
	</InstallExecuteSequence>

		</Product>
</Wix>
